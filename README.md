# Fightstick Visualizer

ヒットボックス型レバーレスコントローラーの入力可視化・カスタマイズWeb UIです。

## 機能

### 🎮 入力検出
- **コントローラー入力**: Gamepad APIを使用してコントローラー入力を検出（Xbox 360対応）

### 🎨 カスタマイズ機能
- **ドラッグ＆ドロップ**: ボタンを自由に配置可能（マウスカーソルに完全追従）
- **キー割り当て**: 各ボタンにコントローラーボタンを割り当て
- **削除機能**: 不要なボタンを削除（×ボタン）

### 💾 データ保存
- **状態保存**: ボタン配置・割り当て・ラベルを一括保存
- **自動復元**: 保存された状態を次回起動時に自動復元
- **手動保存/復元**: 「現在の状態を保存」「保存した状態を復元」ボタンで手動操作も可能

### 📺 OBS対応
- **OBS用HTML生成**: 設定した内容でOBS用のオーバーレイHTMLを生成
- **透明背景**: OBSで使用しやすい透明背景
- **軽量**: 配信に影響しない軽量なコード
- **リアルタイム反映**: キーボード・ゲームパッド入力がOBSでもリアルタイム表示

### 🔧 デバッグ機能
- **デバッグ情報表示**: ゲームパッド接続状態・ボタン状態・割り当て情報を表示
- **フォーカス状態監視**: ページの可視性・フォーカス状態を監視
- **ポーリング方式切り替え**: ページ表示中はrequestAnimationFrame、非表示時はsetIntervalで最適化

## 初期レイアウト

ヒットボックス型の標準的な配置になっています：

```
     [上]
[左] [下] [右]

[LP] [MP] [HP] [LK]
[MK] [HK] [L]  [M]
[H]  [S1] [S2] [S3]
```

## 使用方法

### 1. 基本操作
1. `index.html`をブラウザで開く

### 2. キー割り当て
1. ボタンをクリック
2. 3秒以内にコントローラーボタンを押す

### 3. ボタン配置
- ボタンをドラッグして自由に移動（マウスカーソルに完全追従）
- 「配置リセット」で初期配置に戻る

### 4. 状態管理
- **現在の状態を保存**: 現在のボタン配置・割り当て・ラベルを保存
- **保存した状態を復元**: 保存された状態を復元（初期化時に自動実行）
- 保存データがある場合は自動復元、ない場合は初期配置で開始

### 5. OBS用ファイル生成
1. 「OBS用HTML生成」ボタンをクリック
2. `fightstick_obs_overlay.html`がダウンロードされる
3. OBSで「ブラウザソース」を追加
4. ローカルファイルとして`fightstick_obs_overlay.html`を読み込み

### OBSがver.31.0.0以降の方
1. OBSのプロパティからショートカットタブを選択
2. リンク先欄の内容を`"C:\Program Files\obs-studio\bin\64bit\obs64.exe" --disable-features=EnableWindowsGamingInputDataFetcher`に変更し、保存
    - 引用符の後に` --disable-features=EnableWindowsGamingInputDataFetcher`
    - ※半角スペースが必要
3. 変更したショートカットからOBSを起動
    - Fightstick Visualizerを使用する場合は必ず変更したショートカットからOBSを起動してください。

## アーキテクチャ

### クラス構造
コードは以下のクラスに分割されており、各クラスが特定の責任を持っています：

- **`FightstickVisualizer`**: メインクラス、各マネージャーを統合・初期化
- **`ButtonManager`**: ボタン生成・配置・削除・ドラッグ移動・状態保存/復元
- **`InputManager`**: ゲームパッド入力の検出、割り当て、アクティブ化/非アクティブ化
- **`GamepadManager`**: Gamepad APIの監視・ポーリング・接続/切断イベント・デバッグ情報
- **`StateManager`**: localStorageへの保存・復元、OBS用HTML生成
- **`UIManager`**: UI更新・通知表示・デバッグ情報表示・ステータス管理

### データフロー
1. **初期化**: 保存データがあれば復元、なければ初期ボタン生成
2. **入力検出**: ゲームパッド入力をリアルタイム検出
3. **状態更新**: 入力に応じてボタンのアクティブ状態を更新
4. **自動保存**: 設定変更時にlocalStorageに自動保存
5. **OBS連携**: 設定内容でOBS用HTMLを生成

## ファイル構成

```
fightstick_visualizer/
├── index.html          # メインHTMLファイル
├── style.css           # スタイルシート
├── script.js           # JavaScript機能（クラスベース）
└── README.md           # このファイル
```

## 技術仕様

- **HTML5**: モダンなWeb標準
- **CSS3**: グラデーション、アニメーション、レスポンシブデザイン
- **JavaScript ES6+**: クラスベースの実装、Gamepad API
- **localStorage**: 設定の永続化
- **Gamepad API**: コントローラー入力検出
- **requestAnimationFrame**: パフォーマンス最適化

## 対応ブラウザ

- Chrome 67+
- Firefox 59+
- Safari 14+
- Edge 79+

## カスタマイズ

### ボタン追加
`script.js`の`ButtonManager.createInitialButtons()`メソッドでボタンを追加できます：

```javascript
{ id: 'newButton', name: '新ボタン', x: 300, y: 300, type: 'action' }
```

### スタイル変更
`style.css`でボタンの見た目をカスタマイズできます：

```css
.fightstick-button {
    width: 80px;  /* サイズ変更 */
    height: 80px;
    background: linear-gradient(145deg, #your-color, #your-color); /* 色変更 */
}
```

### クラス拡張
各マネージャークラスを拡張して機能を追加できます：

```javascript
class CustomButtonManager extends ButtonManager {
    // カスタム機能を追加
}
```

## トラブルシューティング

### コントローラーが認識されない
1. ブラウザがGamepad APIをサポートしているか確認
2. コントローラーが正しく接続されているか確認
3. ブラウザを再起動
4. デバッグ情報で接続状態を確認

### 設定が保存されない
1. ブラウザのlocalStorageが有効か確認
2. プライベートブラウジングモードでないか確認
3. ブラウザの容量制限を確認

### OBSで表示されない
1. ファイルパスが正しいか確認
2. OBSのブラウザソース設定を確認
3. ファイルを直接ブラウザで開いて動作確認
4. OBSのキャッシュをクリア

### ドラッグが滑らかでない
1. ブラウザのハードウェアアクセラレーションが有効か確認
2. 他のアプリケーションのCPU使用率を確認
3. ブラウザを再起動

## 更新履歴

### v2.0.0 (リファクタリング版)
- クラスベースのアーキテクチャに変更
- 各機能を独立したマネージャークラスに分割
- ドラッグ＆ドロップの動作を改善（マウスカーソル完全追従）
- 状態保存・復元機能を強化
- デバッグ機能を追加
- パフォーマンス最適化

### v1.0.0 (初期版)
- 基本的な入力検出機能
- ドラッグ＆ドロップ
- OBS対応

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。 